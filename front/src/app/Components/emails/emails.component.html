<div class="email-container">
  <!-- Close Button -->
  <button class="close-btn" (click)="dialogRef.close()">✕</button>

  <!-- Control Buttons -->
  <div class="control-buttons">
    <button (click)="displayPdfAttachment()" [disabled]="selectedAttachments.length === 0 || isProcessingMode">
      View {{selectedAttachments.length}} Selected PDF{{selectedAttachments.length > 1 ? 's' : ''}}
    </button>
    
    <button (click)="displayAndProcessPdfAttachment()" [disabled]="selectedAttachments.length === 0 || isProcessingMode">
      Process {{selectedAttachments.length}} Selected PDF{{selectedAttachments.length > 1 ? 's' : ''}}
    </button>

    <button (click)="selectAllAttachments()" [disabled]="getAllAttachments().length === 0 || isProcessingMode">
      Select All ({{getAllAttachments().length}})
    </button>

    <button (click)="clearSelection()" [disabled]="selectedAttachments.length === 0 || isProcessingMode">
      Clear Selection
    </button>

    <button *ngIf="isProcessingMode" (click)="exitProcessingMode()" class="exit-processing-btn">
      Back to Emails
    </button>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Emails List -->
    <div class="emails-section" [class.with-pdf]="displayedPdfUrls.length > 0" [class.hidden]="isProcessingMode">
      
      <!-- Selected Attachments Summary -->
      <div *ngIf="selectedAttachments.length > 0" class="selected-summary">
        <h4>Selected Attachments ({{selectedAttachments.length}})</h4>
        <div class="selected-items">
          <span *ngFor="let attachment of selectedAttachments" class="selected-item">
            {{attachment.fileName}}
            <button (click)="removeFromSelection(attachment)">×</button>
          </span>
        </div>
      </div>

      <!-- Email Cards -->
      <div *ngFor="let email of emails" class="email-card">
        <div class="email-header">
          <h3>{{email.subject}}</h3>
          <div class="email-meta">
            <span>From: {{email.from}}</span>
            <span>Date: {{email.date | date:'medium'}}</span>
          </div>
        </div>

        <div *ngIf="email.attachments?.length" class="attachments-section">
          <h4>Attachments ({{email.attachments.length}})</h4>
          <div class="attachments-grid">
            <div *ngFor="let attachment of email.attachments" 
                 class="attachment-item"
                 [class.selected]="isAttachmentSelected(attachment)"
                 (click)="toggleAttachmentSelection(attachment, email.id)"
                 (contextmenu)="fetchAndDisplayPdf(email.id, attachment); $event.preventDefault()">
              
              <div class="attachment-info">
                <div class="file-name">{{attachment.fileName }}</div>
                <div class="file-size">{{attachment.fileSize }}</div>
                <div *ngIf="isAttachmentSelected(attachment)" class="selected-indicator">✓</div>
              </div>

              <div *ngIf="uploadProgress !== null" class="progress-bar">
                <div class="progress-fill" [style.width.%]="uploadProgress"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PDF Viewer Section -->
    <div class="pdf-section" *ngIf="displayedPdfUrls.length > 0" [class.full-width]="isProcessingMode">
      <div class="pdf-header">
        <h4>PDF Viewers ({{displayedPdfUrls.length}})</h4>
        <button (click)="closePdfViewer()">Close</button>
      </div>
      <div class="pdf-viewers-container">
        <div *ngFor="let pdfData of displayedPdfUrls; let i = index" class="pdf-viewer-item">
          <div class="pdf-item-header">
            <h5>{{pdfData.attachment.fileName }}</h5>
            <span class="pdf-item-size">{{pdfData.attachment.fileSize }}</span>
          </div>
          <div class="pdf-viewer-container">
            <pdf-viewer [src]="pdfData.url" 
                        [render-text]="true" 
                        [original-size]="false"
                        [fit-to-page]="true"
                        [zoom]="0.8"
                        style="display: block; width: 100%; height: 100%;"
                        (error)="onPdfViewerError($event)">
            </pdf-viewer>
          </div>
        </div>
      </div>
    </div>
    <div *ngIf="analysesList">
            <app-email-analyses-list [extractionResponse]="analysesList"></app-email-analyses-list>
    </div>
  </div>
</div>